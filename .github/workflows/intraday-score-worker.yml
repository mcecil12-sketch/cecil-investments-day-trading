name: intraday-score-worker

on:
  schedule:
    # Market hours ET (09:30-16:00), converted to UTC (14:30-21:00)
    - cron: "30-59/5 14 * * 1-5"
    - cron: "*/5 15-20 * * 1-5"
    - cron: "0 21 * * 1-5"
  workflow_dispatch:

jobs:
  score:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        worker: [1, 2, 3]
    steps:
      - name: Intraday scoring worker
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          RUN_ID="gha-intraday-score-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-w${{ matrix.worker }}-${NOW}"

          OPS="$(curl -sS "$BASE/api/ops/status?_=$NOW")"
          IS_OPEN="$(echo "$OPS" | jq -r '.market.is_open // false')"
          if [ "$IS_OPEN" != "true" ]; then
            echo "market_closed; exiting"
            exit 0
          fi

          echo "RUN_ID=$RUN_ID"
          echo "drain recent-first (intraday), worker=${{ matrix.worker }}"

          curl -sS --max-time 90 -X POST \
            "$BASE/api/ai/score/drain?limit=2&releaseLimit=0&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | jq '{attemptedCount,completedCount,timeoutCount,scoredCount,durationMs,remainingTimeMs,pickedStrategy}'
