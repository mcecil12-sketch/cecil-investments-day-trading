name: Auto-Entry Execute

on:
  schedule:
    - cron: "*/5 14-21 * * 1-5"
  workflow_dispatch: {}

concurrency:
  group: autotrade-execute
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    steps:
      - name: Call auto-entry execute
        env:
          PROD: https://cecil-investments-day-trading.vercel.app
          AUTO_ENTRY_TOKEN: ${{ secrets.AUTO_ENTRY_TOKEN }}
        run: |
          set -euo pipefail

          RUN_ID="gh-auto-entry-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%s)"

          SEED_BODY="$(curl -sS -X POST "$PROD/api/auto-entry/seed-from-signals" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{"limit":3,"minScore":7.5}')"

          echo "$SEED_BODY"
          echo "$SEED_BODY" | jq -r '.' >/dev/null

          BODY="$(curl -sS -X POST "$PROD/api/auto-entry/execute" \
            -H "Content-Type: application/json" \
            -H "x-auto-entry-token: $AUTO_ENTRY_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' )"

          echo "$BODY"
          echo "$BODY" | jq -r '.' >/dev/null

      - name: Call auto-manage run (3x ~2m cadence)
        env:
          PROD: https://cecil-investments-day-trading.vercel.app
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail

          for i in 1 2 3; do
            RUN_ID="gh-auto-manage-$i-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%s)"

            BODY="$(curl -sS -X POST "$PROD/api/auto-manage/run" \
              -H "Content-Type: application/json" \
              -H "x-cron-token: $CRON_TOKEN" \
              -H "x-run-source: github-actions" \
              -H "x-run-id: $RUN_ID" \
              -d '{}' )"

            echo "$BODY"
            echo "$BODY" | jq -r '.' >/dev/null

            if [ "$i" -lt 3 ]; then
              sleep 120
            fi
          done
