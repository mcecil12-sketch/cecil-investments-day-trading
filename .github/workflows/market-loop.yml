name: market-loop

on:
  schedule:
    # Jan (EST) market hours: 9:35–15:55 ET ~= 14:35–20:55 UTC
    - cron: "*/5 14-20 * * 1-5"
  workflow_dispatch:

jobs:
  loop:
    runs-on: ubuntu-latest
    steps:
      - name: run loop
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          SCANNER_TOKEN: ${{ secrets.SCANNER_TOKEN }}
          AUTO_ENTRY_TOKEN: ${{ secrets.AUTO_ENTRY_TOKEN }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gha-market-loop-$(date +%s)"
          echo "RUN_ID=$RUN_ID"

          echo "=== scan ai-seed ==="
          curl -sS -X POST "$BASE/api/scan?mode=ai-seed" \
            -H "Content-Type: application/json" \
            -H "x-scanner-token: $SCANNER_TOKEN" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: $RUN_ID" \
            -d '{}' | head -c 2000 || true
          echo

          echo "=== auto-entry execute ==="
          curl -sS -X POST "$BASE/api/auto-entry/execute" \
            -H "Content-Type: application/json" \
            -H "x-auto-entry-token: $AUTO_ENTRY_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' | head -c 2000 || true
          echo

          echo "=== auto-manage run ==="
          curl -sS -X POST "$BASE/api/auto-manage/run" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' | head -c 2000 || true
          echo
