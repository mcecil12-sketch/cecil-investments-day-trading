name: market-loop

on:
  schedule:
    # Run every 5 minutes during market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
    - cron: "*/5 14-21 * * 1-5"
  workflow_dispatch:

jobs:
  loop:
    runs-on: ubuntu-latest
    steps:
      - name: Sync broker state
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gha-market-loop-sync-$(date +%s)"
          CODE="$(curl -sS -o /tmp/sync_broker_state.json -w "%{http_code}" -X POST "$BASE/api/maintenance/sync-broker-state" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: gha-market-loop" \
            -H "x-run-id: $RUN_ID" \
            -d '{}')"
          cat /tmp/sync_broker_state.json | head -c 4000 || true
          echo
          echo "HTTP $CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "WARN: sync-broker-state failed (non-fatal). Continuing."
          fi

      - name: Reconcile ghost open trades
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gh-reconcile-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%s)"
          echo "RUN_ID=$RUN_ID"
          curl -sS --max-time 60 -X POST "$BASE/api/maintenance/reconcile-open-trades?_=$(date +%s)" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -H "Content-Type: application/json" \
            -d '{"dryRun":false}' | head -c 2000 || true
          echo ""

      - name: run loop
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          SCANNER_TOKEN: ${{ secrets.SCANNER_TOKEN }}
          AUTO_ENTRY_TOKEN: ${{ secrets.AUTO_ENTRY_TOKEN }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gha-market-loop-$(date +%s)"
          echo "RUN_ID=$RUN_ID"
          echo "BASE_SET=$([ -n "${BASE:-}" ] && echo 1 || echo 0)"
          echo "SCANNER_TOKEN_LEN=${#SCANNER_TOKEN}"
          echo "AUTO_ENTRY_TOKEN_LEN=${#AUTO_ENTRY_TOKEN}"
          echo "CRON_TOKEN_LEN=${#CRON_TOKEN}"

          if [ -z "${BASE:-}" ]; then
            echo "FATAL: PROD_BASE_URL missing"
            exit 1
          fi

          ET_HHMM="$(TZ=America/New_York date +%H%M)"
          ET_MIN="$(TZ=America/New_York date +%M)"
          echo "ET_HHMM=$ET_HHMM ET_MIN=$ET_MIN"

          IN_OPENING_WINDOW=0
          if [ "$ET_HHMM" -ge "0930" ] && [ "$ET_HHMM" -le "1030" ]; then
            IN_OPENING_WINDOW=1
          fi

          if [ "$IN_OPENING_WINDOW" -ne 1 ]; then
            if [ $((10#$ET_MIN % 5)) -ne 0 ]; then
              echo "skip cadence: outside opening window and not on 5-min boundary"
              exit 0
            fi
          fi

          echo "=== scan ai-seed ==="
          curl -sS -X POST "$BASE/api/scan?mode=ai-seed" \
            -H "Content-Type: application/json" \
            -H "x-scanner-token: $SCANNER_TOKEN" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== score pending signals ==="
          curl -sS -X POST "$BASE/api/signals/score-pending?limit=25&sinceHours=6" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== auto-entry seed-from-signals ==="
          curl -sS -X POST "$BASE/api/auto-entry/seed-from-signals" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{"limit":3,"minScore":7.5}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== auto-entry execute ==="
          curl -sS -X POST "$BASE/api/auto-entry/execute" \
            -H "Content-Type: application/json" \
            -H "x-auto-entry-token: $AUTO_ENTRY_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== auto-manage run ==="
          curl -sS -X POST "$BASE/api/auto-manage/run" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

      - name: Finalize closes
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gh-market-loop-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%s)"
          echo "=== finalize-closes ==="
          curl -sS -X POST "$BASE/api/maintenance/finalize-closes?limit=25" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

      - name: Scorecard recompute
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          DATE_ET="$(TZ=America/New_York date +%F)"
          RUN_ID="gh-scorecard-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%s)"
          CODE="$(curl -sS -o /tmp/scorecard.json -w "%{http_code}" -X POST "$BASE/api/scorecard/recompute" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d "{\"dateET\":\"$DATE_ET\"}")"
          cat /tmp/scorecard.json | head -c 4000 || true
          echo
          echo "HTTP $CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "WARN: sync-broker-state failed (non-fatal). Continuing."
          fi

      - name: Snapshot performance equity
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          curl -sS -X POST "$BASE/api/performance/snapshot" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: gha-${{ github.run_id }}-${{ github.run_attempt }}-${{ github.job }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000

      - name: Final tiny drain (recent-first)
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          curl -4 -sS --max-time 90 -X POST \
            "$BASE/api/ai/score/drain?limit=8&releaseLimit=0&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | head -c 2000; echo
