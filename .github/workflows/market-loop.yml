name: market-loop

on:
  schedule:
    - cron: "*/5 14-20 * * 1-5"
  workflow_dispatch:

jobs:
  loop:
    runs-on: ubuntu-latest
    steps:
      - name: run loop
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          SCANNER_TOKEN: ${{ secrets.SCANNER_TOKEN }}
          AUTO_ENTRY_TOKEN: ${{ secrets.AUTO_ENTRY_TOKEN }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="gha-market-loop-$(date +%s)"
          echo "RUN_ID=$RUN_ID"
          echo "BASE_SET=$([ -n "${BASE:-}" ] && echo 1 || echo 0)"
          echo "SCANNER_TOKEN_LEN=${#SCANNER_TOKEN}"
          echo "AUTO_ENTRY_TOKEN_LEN=${#AUTO_ENTRY_TOKEN}"
          echo "CRON_TOKEN_LEN=${#CRON_TOKEN}"

          echo "=== scan ai-seed ==="
          curl -sS -X POST "$BASE/api/scan?mode=ai-seed" \
            -H "Content-Type: application/json" \
            -H "x-scanner-token: $SCANNER_TOKEN" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== auto-entry execute ==="
          curl -sS -X POST "$BASE/api/auto-entry/execute" \
            -H "Content-Type: application/json" \
            -H "x-auto-entry-token: $AUTO_ENTRY_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo

          echo "=== auto-manage run ==="
          curl -sS -X POST "$BASE/api/auto-manage/run" \
            -H "Content-Type: application/json" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "x-run-source: github-actions" \
            -H "x-run-id: $RUN_ID" \
            -d '{}' \
            -w "\nHTTP %{http_code}\n" | head -c 4000 || true
          echo
