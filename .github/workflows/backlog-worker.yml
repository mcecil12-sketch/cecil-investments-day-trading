name: backlog-worker

on:
  schedule:
    # Run every 15 minutes after market close through overnight (UTC) on weekdays
    # 21-23 and 0-12 UTC, Mon-Fri
    - cron: "*/15 21-23 * * 1-5"
    - cron: "*/15 0-12 * * 1-5"
    # Run every 15 minutes all day on weekends
    - cron: "*/15 * * * 6,0"
    # Archive old signals daily at 02:10 UTC
    - cron: "10 2 * * *"
  workflow_dispatch:

jobs:
  drain:
    runs-on: ubuntu-latest
    steps:
      - name: Backlog drain (oldest-first)
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          curl -4 -sS --max-time 120 -X POST \
            "$BASE/api/ai/score/drain?limit=5&backlog=1&releaseLimit=3&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | head -c 4000; echo

  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Archive old signals
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          curl -4 -sS --max-time 120 -X POST \
            "$BASE/api/signals/archive?olderThanDays=2&status=PENDING&limit=2000&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | head -c 4000; echo