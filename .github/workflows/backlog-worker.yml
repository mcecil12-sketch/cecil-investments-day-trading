name: backlog-worker

on:
  schedule:
    # Run every hour after market hours and on weekends
    # 0-4 = Sun-Thu pre-open (before 9:30 AM ET = 13:30 UTC)
    # 22-23 = after market close (after 4:00 PM ET = 20:00 UTC on same day + overnight)
    - cron: "0 0-4 * * *"
    - cron: "0 22-23 * * *"
  workflow_dispatch:

jobs:
  backlog:
    runs-on: ubuntu-latest
    steps:
      - name: Backlog drain (oldest-first)
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          curl -4 -sS --max-time 120 -X POST \
            "$BASE/api/ai/score/drain?limit=50&backlog=1&releaseLimit=10&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | head -c 4000; echo

      - name: Archive old signals
        env:
          BASE: ${{ secrets.PROD_BASE_URL }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          set -euo pipefail
          NOW="$(date +%s)"
          curl -4 -sS --max-time 120 -X POST \
            "$BASE/api/signals/archive?olderThanDays=2&status=PENDING&limit=2000&_=$NOW" \
            -H "x-cron-token: $CRON_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | head -c 4000; echo