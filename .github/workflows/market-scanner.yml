name: Market Scanner

on:
  schedule:
    - cron: "*/5 * * * 1-5"
  workflow_dispatch:

jobs:
  run-scanners:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh AI heartbeat
        run: |
          curl -sS -L -w "HTTP_STATUS=%{http_code}\n" "${{ secrets.SCANNER_BASE_URL }}/api/ai-heartbeat" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"source":"github-actions"}' || true

      - name: Hit VWAP pullback scanner
        run: |
          RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          curl -sS -L --retry 3 --retry-delay 3 --retry-all-errors \
            -H "x-scanner-token: ${{ secrets.SCANNER_TOKEN }}" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: ${RUN_ID}" \
            -w "HTTP_STATUS=%{http_code}\n" \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=vwap" | tail -200 || true

      - name: Hit breakout scanner
        run: |
          RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          curl -sS -L --retry 3 --retry-delay 3 --retry-all-errors \
            -H "x-scanner-token: ${{ secrets.SCANNER_TOKEN }}" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: ${RUN_ID}" \
            -w "HTTP_STATUS=%{http_code}\n" \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=breakout" | tail -200 || true

      - name: Hit compression/NR7 scanner
        run: |
          RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          curl -sS -L --retry 3 --retry-delay 3 --retry-all-errors \
            -H "x-scanner-token: ${{ secrets.SCANNER_TOKEN }}" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: ${RUN_ID}" \
            -w "HTTP_STATUS=%{http_code}\n" \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=compression" | tail -200 || true

      - name: Hit ai-seed scanner with retries
        run: |
          set -e
          RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "UTC now: $(date -u)"
          echo "Hitting: $SCANNER_BASE_URL/api/scan?mode=ai-seed"
          curl -fsS -L --retry 5 --retry-delay 5 --retry-all-errors \
            -H "x-scanner-token: ${{ secrets.SCANNER_TOKEN }}" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: ${RUN_ID}" \
            -w "HTTP_STATUS=%{http_code}\n" \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=ai-seed" | tail -200

      - name: Hit short scanner
        run: |
          RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Hitting: $SCANNER_BASE_URL/api/scan?mode=short"
          curl -sS -L --retry 3 --retry-delay 3 --retry-all-errors \
            -H "x-scanner-token: ${{ secrets.SCANNER_TOKEN }}" \
            -H "x-scan-source: github-actions" \
            -H "x-scan-run-id: ${RUN_ID}" \
            -w "HTTP_STATUS=%{http_code}\n" \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=short" | tail -200 || true

      # Uncomment to backstop premarket via Actions as well
      # - name: Hit premarket VWAP scanner
      #   run: |
      #     curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=premarket" || true
