name: Market Scanner

on:
  schedule:
    - cron: "*/5 * * * 1-5"
  workflow_dispatch:

jobs:
  run-scanners:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh AI heartbeat
        run: |
          curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/ai-heartbeat" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"source":"github-actions"}' || true

      - name: Hit VWAP pullback scanner
        run: |
          curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=vwap" || true

      - name: Hit breakout scanner
        run: |
          curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=breakout" || true

      - name: Hit compression/NR7 scanner
        run: |
          curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=compression" || true

      - name: Hit ai-seed scanner with retries
        run: |
          set -e
          echo "UTC now: $(date -u)"
          echo "Hitting: $SCANNER_BASE_URL/api/scan?mode=ai-seed"
          curl -fsS --retry 5 --retry-delay 5 --retry-all-errors \
            "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=ai-seed"

      # Uncomment to backstop premarket via Actions as well
      # - name: Hit premarket VWAP scanner
      #   run: |
      #     curl -sS "${{ secrets.SCANNER_BASE_URL }}/api/scan?mode=premarket" || true
